<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"   
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="CoursesDaoMapper">
	<resultMap type="com.tuzhi.app.pojo.CoursesInfo" id="resultCourses"/>
	
	<!-- 查询我的课程  userid＝－1查询所有课程  -->
	<select id="getMyCourses" parameterType="map" resultMap="resultCourses">
	  select top (convert(int,#{rows})) temp.* from (
		select row_number() over (order by c.create_time desc) as RowNumber,c.*,ct.name ctname,acu.cnt study_num from app_courses c
			 left join app_courses_type ct on c.courses_type_id=ct.id
			 inner join(
			           select cu.courses_id,cu.type,COUNT(*) cnt from app_courses_user cu
			           <if test=" user_id !='-1'.toString() ">
			              where cu.user_id=#{user_id}
			           </if>
			           group by cu.courses_id,cu.type
			          )acu on c.id=acu.courses_id
			 where 1=1 
 			<if test=" user_id !='-1'.toString() ">
		  		 <if test="title !=null and title !='' ">
					and c.name=#{title}
				 </if>
				 <if test="type !=null and type !='' ">
					and acu.type=#{type}
				 </if>
				 <if test="course_type_id !=null and course_type_id !='' ">
					and ct.id=#{course_type_id}
				 </if>
			</if>	 
		) as temp where RowNumber > convert(int,#{rows})*(convert(int,#{page})-1) order by temp.create_time desc
	</select>
	
	<!-- 获取章节  -->
	<select id="getChapter" parameterType="map" resultMap="resultCourses">
		select ch.id chapter_id,ch.title chapter_title,cr.content,cr.id from app_chapter ch
		  left join app_courses_chapter cc on ch.id=cc.chapter_id
		  left join app_courses cr on cc.courses_id=cr.id
		  where 1=1 
	  		 <if test="course_id !=null and course_id !='' ">
				and cr.id=#{course_id}
			 </if>
	</select>
	
	<!-- 获取课时  -->
	<select id="getClass" parameterType="map" resultMap="resultCourses">
		select cl.id class_id,cl.title class_title,cl.class_url,cl.time class_time 
		   from app_class cl 
           left join app_chapter_class chl on cl.id=chl.class_id
           where 1=1 
	  		 <if test="chapter_id !=null and chapter_id !='' ">
	  		 	and chl.chapter_id=#{chapter_id}
			 </if>
	</select>
	
	<!-- 查询该用户，是否拥有该课程  -->
	<select id="getCoursesUser" parameterType="map" resultType="Int">
		select count(*) from app_courses_user cu where cu.courses_id=#{courses_id} and cu.user_id=#{user_id} and cu.type=#{type}
	</select>
	
    <!-- 将该课程，添加到该用户下  -->
	<insert id="addCoursesUser" parameterType="map">
		insert into app_courses_user(courses_id,user_id,type) values(#{courses_id},#{user_id},#{type})
	</insert>
	
	
</mapper>